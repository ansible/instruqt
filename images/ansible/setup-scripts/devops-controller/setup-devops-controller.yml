---
##
# https://play.instruqt.com/redhat/tracks/devops-controller/
#
# Tags:
# setup-env - Setup all lifecycle scripts
# auth-token - create controller auth-token
# <hostname>-config - Lifecycle setup script for host
# <challenge-slug>-check - check challenge 
# <challenge-slug>-solve - solve challenge 
# <challenge-slug>-setup - setup challenge
##

#Gitea config
- name: Configure Gitea host
  hosts: gitea
  gather_facts: false
  become: true
  tags:
    - gitea-config
  
  tasks:
    - name: Install python3 Gitea
      ansible.builtin.raw: /sbin/apk add python3

    - name: Install Gitea packages
      community.general.apk:
        name: subversion, tar
        state: present
        
    - name: Create setup-scripts directory
      ansible.builtin.file:
        path: /tmp/setup-scripts/devops-controller
        state: directory
        
    - name: Download lab content to controller tmp directory
      ansible.builtin.subversion:
        repo: "{{ download_url }}"
        dest: /tmp/setup-scripts/devops-controller
        export: true
        force: true

    - name: Create repo users
      ansible.builtin.command: "{{ item }}"
      become_user: git
      register: __output
      failed_when: __output.rc not in [ 0, 1 ]
      changed_when: '"user already exists" not in __output.stdout'
      loop:
        - "/usr/local/bin/gitea admin user create --admin --username jenkins --password {{ student_password }} --must-change-password=false --email jenkins@localhost"
        - "/usr/local/bin/gitea admin user create --admin --username {{ student_user }} --password {{ student_password }} --must-change-password=false --email {{ student_user }}@localhost"

    - name: Create repo
      ansible.builtin.uri:
        url: http://gitea:3000/api/v1/user/repos
        method: POST
        body_format: json
        body:
          name: acme_corp
          auto_init: false
          private: false
        force_basic_auth: true
        url_password: "{{ student_password }}"
        url_username: "{{ student_user }}"
        status_code: [ 201, 409 ]

    - name: Create repo webhook
      ansible.builtin.uri:
        url: "http://gitea:3000/api/v1/repos/{{ student_user }}/acme_corp/hooks"
        method: POST
        body_format: json
        body:
          type: gitea
          config:
            content_type: json
            url: http://jenkins:8080/gitea-webhook/post
          active: true
          events:
            - push
        force_basic_auth: true
        url_password: "{{ student_password }}"
        url_username: "{{ student_user }}"
        status_code: [ 201, 409 ]

    - name: Remove repo dir if it exists
      ansible.builtin.file:
        path: "/root/acme_corp"
        state: absent

    - name: Create repo dir
      ansible.builtin.file:
        path: "/root/acme_corp"
        state: directory
        mode: 0755

    - name: Configure git to use main repo by default
      community.general.git_config:
        name: init.defaultBranch
        scope: global
        value: main
      tags:
        - git

    - name: Initialise track repo
      ansible.builtin.command:
        cmd: /usr/bin/git init
        chdir: "/root/acme_corp"
        creates: "/acme_corp/.git" 

    - name: Configure git to store credentials
      community.general.git_config:
        name: credential.helper
        scope: global
        value: store --file /tmp/git-creds

    - name: Configure repo dir as git safe dir
      community.general.git_config:
        name: safe.directory
        scope: global
        value: "/root/acme_corp"

    - name: Store repo credentials in git-creds file
      ansible.builtin.copy:
        dest: /tmp/git-creds
        mode: 0644
        content: "http://{{ student_user }}:{{ student_password }}@{{ 'gitea:3000' | urlencode }}"

    - name: Configure git username
      community.general.git_config:
        name: user.name
        scope: global
        value: "{{ ansible_user }}"

    - name: Configure git email address
      community.general.git_config:
        name: user.email
        scope: global
        value: "{{ ansible_user }}@local"

    - name: Extract initial repo files
      ansible.builtin.unarchive:
        src: /tmp/setup-scripts/devops-controller/files/acme_repo.tar.gz
        dest: "/root/acme_corp"
        creates: /root/acme_corp/app
        remote_src: true

    - name: Add remote origin to repo
      ansible.builtin.command:
        cmd: "{{ item }}"
        chdir: "/root/acme_corp"   
      register: __output
      changed_when: __output.rc == 0
      loop:
        - "git remote add origin http://gitea:3000/{{ student_user }}/acme_corp.git"
        - "git checkout -b main"
        - "git add ."
        - "git commit -m'Initial commit'"
        - "git push -u origin main --force"

# Jenkins config
- name: Jenkins config for devops-controller
  hosts: jenkins
  gather_facts: false
  tags:
    - jenkins-config

  tasks:
    - name: Create setup-scripts directory
      ansible.builtin.file:
        path: /tmp/setup-scripts/devops-controller
        state: directory

    - name: Download lab content to tmp directory
      ansible.builtin.subversion:
        repo: "{{ download_url }}"
        dest: /tmp/setup-scripts/devops-controller
        export: true
        force: true

    - name: Install jenkins-cli
      ansible.builtin.get_url:
        url: http://jenkins:8080/jnlpJars/jenkins-cli.jar
        dest: /var/jenkins_home/jenkins-cli.jar
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0644"

    - name: Create Jenkins jobs
      ansible.builtin.shell:
        chdir: /var/jenkins_home
        cmd: "/opt/java/openjdk/bin/java -jar /var/jenkins_home/jenkins-cli.jar -s http://jenkins:8080 -auth {{ student_user }}:{{ student_password }} create-job {{ item.name }} < {{ item.template_file }}"
      loop: "{{ jenkins_jobs }}"
      register: __output
      changed_when: __output.rc != 4
      failed_when: __output.rc not in [ 0, 4 ]
    
# Controller setup
- name: Controller config for devops-controller
  hosts: controller
  gather_facts: true
    
  tasks:
   # Create auth login token
    - name: get auth token and restart automation-controller if it fails
      block:
        - name: Refresh facts
          setup:

        - name: Create oauth token
          awx.awx.token:
            description: 'Instruqt lab'
            scope: "write"
            state: present
            controller_config_file: "{{ playbook_dir }}/../controller.cfg"
          register: _auth_token
          until: _auth_token is not failed
          delay: 3
          retries: 5
      rescue:
        - name: In rescue block for auth token
          debug:
            msg: "failed to get auth token. Restarting automation controller service"

        - name: restart the controller service
          ansible.builtin.service:
            name: automation-controller
            state: restarted

        - name: Ensure tower/controller is online and working
          uri:
            url: https://localhost/api/v2/ping/
            method: GET
            user: "{{ admin_username }}"
            password: "{{ admin_password }}"
            validate_certs: false
            force_basic_auth: true
          register: controller_online
          until: controller_online is success
          delay: 3
          retries: 5

        - name: Retry getting auth token
          awx.awx.token:
            description: 'Instruqt lab'
            scope: "write"
            state: present
            controller_config_file: "{{ playbook_dir }}/../controller.cfg"  
            validate_certs: false
          register: _auth_token
          until: _auth_token is not failed
          delay: 3
          retries: 5
      always:
        - name: Create fact.d dir
          ansible.builtin.file:
            path: "{{ custom_facts_dir }}"
            state: directory
            recurse: yes
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
            mode: 0755
          become: true

        - name: Create _auth_token custom fact
          ansible.builtin.copy:
            content: "{{ _auth_token.ansible_facts }}"
            dest: "{{ custom_facts_dir }}/{{ custom_facts_file }}"
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
            mode: 0644
          become: true
      check_mode: false
      when: ansible_local.custom_facts.controller_token is undefined
      tags:
        - auth-token

    - name: refresh facts
      setup:
        filter:
          - ansible_local
      tags:
        - always

    - name: create auth token fact
      ansible.builtin.set_fact:
        auth_token: "{{ ansible_local.custom_facts.controller_token }}"
        cacheable: true
      check_mode: false
      when: auth_token is undefined
      tags:
        - always

  # Setup student git repo
    - name: Remove repo dir if it exists
      ansible.builtin.file:
        path: "/home/{{ ansible_user }}/acme_corp"
        state: absent
      tags:
        - controller-config

    - name: Configure git to use main repo by default
      community.general.git_config:
        name: init.defaultBranch
        scope: global
        value: main
      become: true
      become_user: "{{ ansible_user }}"
      tags:
        - controller-config

    - name: Configure git to store credentials
      community.general.git_config:
        name: credential.helper
        scope: global
        value: store --file /tmp/git-creds
      become: true
      become_user: "{{ ansible_user }}"
      tags:
        - controller-config

    - name: Configure repo dir as git safe dir
      community.general.git_config:
        name: safe.directory
        scope: global
        value: "/home/{{ ansible_user }}/acme_corp"
      become: true
      become_user: "{{ ansible_user }}"
      tags:
        - controller-config

    - name: Store repo credentials in git-creds file
      ansible.builtin.copy:
        dest: /tmp/git-creds
        content: "http://{{ student_user }}:{{ student_password }}@{{ 'gitea:3000' | urlencode }}"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: 0644
      tags:
        - controller-config

    - name: Configure git username
      community.general.git_config:
        name: user.name
        scope: global
        value: "{{ ansible_user }}"
      become: true
      become_user: "{{ ansible_user }}"
      tags:
        - controller-config
      
    - name: Configure git email address
      community.general.git_config:
        name: user.email
        scope: global
        value: "{{ ansible_user }}@local"
      become: true
      become_user: "{{ ansible_user }}"
      tags:
        - controller-config

    - name: Pull repo from SCM
      ansible.builtin.git:
        repo: "{{ git_repo }}"
        dest: "/home/{{ ansible_user }}/acme_corp"
      become: true
      become_user: "{{ ansible_user }}"
      tags:
        - controller-config

    - name: Install OS packages
      ansible.builtin.package:
        name:
          - python3-setuptools
          - virtualenv
        state: present
      become: true
      tags:
        - controller-config
        - controller-packages

    - name: Install Python packages in virtualenv
      ansible.builtin.pip:
        requirements: "/home/rhel/acme_corp/playbooks/files/requirements_prod.txt"
        virtualenv: /home/rhel/.virtualenvs/acme_corp
      become: true
      become_user: "{{ ansible_user }}"
      tags:
        - controller-config
        - controller-packages

 
    - name: Ensure tower/controller is online and working
      uri:
        url: https://localhost/api/v2/ping/
        method: GET
        user: "{{ admin_username }}"
        password: "{{ admin_password }}"
        validate_certs: false
        force_basic_auth: true
      register: controller_online
      until: controller_online is success
      delay: 3
      retries: 5
      tags:
        - controller-config

# Controller objects
    - name: Add Organization
      awx.awx.organization:
        name: "{{ lab_organization }}"
        description: "ACME Corp Organization"
        state: present
        controller_oauthtoken: "{{ auth_token }}"
        validate_certs: false
      tags:
        - controller-config
        - controller-org
  
    - name: Add Instruqt DevOps EE
      awx.awx.execution_environment:
        name: "{{ controller_devops_ee }}"
        image: "quay.io/acme_corp/instruqt-devops-ee"
        pull: missing
        state: present
        controller_oauthtoken: "{{ auth_token }}"
        controller_host: "{{ controller_hostname }}"
        validate_certs: "{{ controller_validate_certs }}"
      tags:
        - controller-config
        - controller-ees

    - name: Pull Instruqt DevOps EE
      containers.podman.podman_image:
        name: "quay.io/acme_corp/instruqt-devops-ee"
      become_user: awx
      register: podman_pull
      until: podman_pull is not failed
      retries: 5
      delay: 15 
      tags:
        - controller-config
        - controller-ees

    - name: Add lab inventories
      awx.awx.inventory:
        name: "{{ item.name }}"
        description: "{{ item.description }}"
        organization: "{{ lab_organization }}"
        state: present
        controller_oauthtoken: "{{ auth_token }}"
        validate_certs: false
      loop: "{{ lab_inventories }}"
      tags:
        - controller-config
        - controller-objects

    - name: Create hosts
      awx.awx.host:
        name: "{{ item.lab_host_name }}"
        inventory: "{{ item.lab_host_inventory }}"
        state: present
        controller_oauthtoken: "{{ auth_token }}"
        validate_certs: false
        variables:  "{{ item.lab_host_vars }}"
      loop: "{{ lab_hosts }}"
      tags:
        - controller-config
        - controller-hosts
    
    - name: Create groups
      awx.awx.group:
        name: "{{ item.group_name }}"
        description: "{{ item.group_desc }}"
        state: present
        inventory: "{{ item.group_inventory }}"
        hosts: "{{ item.group_hosts }}"
        controller_oauthtoken: "{{ auth_token }}"
        controller_host: "{{ controller_hostname }}"
        validate_certs: "{{ controller_validate_certs }}"
      loop: "{{ lab_groups }}"
      tags:
        - controller-config
        - controller-groups

    - name: Add the lab ssh credential
      awx.awx.credential:
        name: "{{ lab_credential_name }}"
        organization: "{{ lab_organization }}"
        credential_type: Machine
        inputs:
          ssh_key_data: "{{ lookup('file', '/home/rhel/.ssh/id_rsa') }}"
        controller_oauthtoken: "{{ auth_token }}"
        validate_certs: false
      tags:
        - controller-config
        - controller-objects

    - name: Add the lab project
      awx.awx.project:
        name: "{{ lab_project_name }}"
        scm_type: git
        scm_url: "http://gitea:3000/{{ student_user }}/acme_corp.git"
        organization: "{{ lab_organization }}"
        scm_update_on_launch: false
        scm_update_cache_timeout: 60
        scm_branch: "main"
        controller_oauthtoken: "{{ auth_token }}"
        validate_certs: false
      tags:
        - controller-config
        - controller-project

    - name: Create job templates
      awx.awx.job_template:
        name: "{{ item.jt_name }}"
        state: present
        execution_environment: "{{ item.execution_env | default ( controller_devops_ee ) }}"
        become_enabled: "{{ item.jt_become }}"
        project: "{{ lab_project_name }}"
        credential: "{{ lab_credential_name }}"
        inventory: "{{  item.jt_inventory }}"
        playbook: "{{ item.jt_playbook }}"
        survey_enabled: "{{ item.survey_enabled | default( omit ) }}"
        survey_spec: "{{ item.survey_spec | default(omit) }}"
        ask_inventory_on_launch: "{{  item.jt_prompt_inventory }}"
        ask_variables_on_launch: "{{  item.jt_prompt_inventory | default( omit )}}"
        extra_vars: "{{ item.jt_extra_vars | default( omit ) }}"
        controller_oauthtoken: "{{ auth_token }}"
        validate_certs: false
      loop: "{{ lab_job_templates }}"
      tags:
        - controller-config
        - controller-jts

    - name: Create Workflows
      awx.awx.tower_workflow_job_template:
        name: "{{ item.workflow_name }}"
        inventory: "{{ item.workflow_inventory }}"
        extra_vars: "{{ item.workflow_vars | default( omit ) }}"
        ask_variables_on_launch: "{{ item.workflow_prompt_vars | default( true ) }}"
        organization:  "{{ item.workflow_org }}"
        schema: "{{ item.workflow_schema | default( omit )}}"
        controller_oauthtoken: "{{ auth_token }}"
        controller_host: "{{ controller_hostname }}"
        validate_certs: "{{ controller_validate_certs }}"
      loop: "{{ lab_devops_worklow }}"
      tags:
        - controller-config
        - controller-workflows

    - name: Add nodes to DevOps workflow
      awx.awx.workflow_job_template_node:
        state: present
        identifier: "{{ item.workflow_node_id }}"
        workflow_job_template: "{{ item.workflow_node_jt }}"
        organization: "{{ item.workflow_node_org }}"
        approval_node: "{{ item.workflow_node_approval | default( omit ) }}"
        unified_job_template: "{{ item.workflow_node_unified_jt | default( omit ) }}"
        success_nodes: "{{ item.workflow_node_success_nodes | default( omit ) }}"
        controller_oauthtoken: "{{ auth_token }}"
        controller_host: "{{ controller_hostname }}"
        validate_certs: "{{ controller_validate_certs }}"
      loop: "{{ lab_devops_worklow_nodes }}"
      tags:
        - controller-config
        - controller-workflows
# Controller users
    ## Users
    - name: Create Jenkins user
      awx.awx.user:
        username: "{{ jenkins_user }}"
        password: "{{ jenkins_password }}"
        email: jenkins@acme.example.com
        controller_oauthtoken: "{{ auth_token }}"
        controller_host: "{{ controller_hostname }}"
        validate_certs: "{{ controller_validate_certs }}"
      tags:
        - controller-config
        - controller-users

    - name: Add jenkins as member of {{ lab_organization }}
      awx.awx.role:
        user: "{{ jenkins_user }}"
        role: member
        state: present
        organization: "{{ lab_organization }}"
        controller_oauthtoken: "{{ auth_token }}"
        controller_host: "{{ controller_hostname }}"
        validate_certs: "{{ controller_validate_certs }}"
      tags:
        - controller-config
        - controller-users

    - name: Give users access to job templates
      awx.awx.role:
        user: "{{ item.user }}"
        role: "{{ item.role }}"
        job_templates: "{{ item.job_template  | default( omit ) }}"
        workflows: "{{ item.workflows | default( omit )}}"
        state: "{{ item.state }}"
        controller_oauthtoken: "{{ auth_token }}"
        controller_host: "{{ controller_hostname }}"
        validate_certs: "{{ controller_validate_certs }}"
      loop: "{{ controller_user_vars }}"
      tags:
        - controller-config
        - controller-users

    - name: Create student admin user
      awx.awx.user:
        superuser: true
        username: "{{ student_user }}"
        password: "{{ student_password }}"
        email: student@acme.example.com
        controller_oauthtoken: "{{ auth_token }}"
        controller_host: "{{ controller_hostname }}"
        validate_certs: "{{ controller_validate_certs }}"
      tags:
        - controller-config
        - controller-users