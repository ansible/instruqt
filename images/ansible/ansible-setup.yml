- name: configures ansible node
  hosts: all
  become: true
  vars:
    - admin_password: 'ansible123!'

  tasks:

    - name: Configure user 'devops'
      ansible.builtin.user:
        name: devops
        shell: /bin/bash
        password: "{{ 'ansible123!' | password_hash('sha512', 'mysecretsalt') }}"
        groups: wheel
        append: yes

    - name: enable sshd password auth
      lineinfile:
        dest: /etc/ssh/sshd_config
        state: present
        regexp: '^PasswordAuthentication'
        line: >-
          PasswordAuthentication yes

    - name: restart sshd
      ansible.builtin.systemd:
        name: sshd
        state: restarted

    - name: Install required packages
      dnf:
        name:
          - vim
          - git
          - wget
          - nano
          - tree
          - sshpass
          - tmux
          - emacs
          - gcc
          - bind-utils
        state: present
      register: dnf_check
      until: dnf_check is not failed
      retries: 4
      delay: 5

    - name: install code server
      vars:
        username: 'devops'
      include_tasks: "./roles/code_server/tasks/codeserver.yml"
